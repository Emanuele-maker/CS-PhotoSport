<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Success</title>
</head>
<body>
    <h1>Congratulazioni! l' acquisto è stato effettuato con successo!</h1>
    <h2>Le immagini acquistate verranno scaricate a breve automaticamente.</h2>
    <a href="/">Torna alla home</a>

    <script>
        let sessionId = localStorage.getItem("sessionId")

        function base64ToBlob(base64, mime) {
            mime = mime || ''
            var sliceSize = 1024
            var byteChars = window.atob(base64)
            var byteArrays = []

            for (var offset = 0, len = byteChars.length; offset < len; offset += sliceSize) {
                var slice = byteChars.slice(offset, offset + sliceSize)

                var byteNumbers = new Array(slice.length)
                for (var i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i)
                }

                var byteArray = new Uint8Array(byteNumbers)

                byteArrays.push(byteArray)
            }
            return new Blob(byteArrays, {type: mime})
        }

        if (!sessionId) console.log("é stato riscontrato un problema...")
        else {
            const getSession = async () => {
                await fetch(`/begin-session/${sessionId}`, {
                    headers : { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                    }
                })
                .then(res => {
                    return res.json()
                })
                .then(data => {
                    localStorage.setItem("sessionId", data.session.id)
                    data.session.boughtImages.forEach(image => {
                        const blobStr = base64ToBlob(image.original, "image/jpg")
                        const blobURL = URL.createObjectURL(blobStr)
                        downloadImage(image, blobURL)
                    })
                })
            }
            getSession()
    }
    </script>
</body>
</html>